<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Психометрический Тест Генератор</title>
    <style>
        :root {
            --color-primary: #2563eb;
            --color-primary-hover: #1d4ed8;
            --color-primary-active: #1e40af;
            --color-secondary: #64748b;
            --color-success: #16a34a;
            --color-error: #dc2626;
            --color-warning: #ea580c;
            --color-bg: #f8fafc;
            --color-surface: #ffffff;
            --color-border: #e2e8f0;
            --color-text: #1e293b;
            --color-text-secondary: #64748b;
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --duration-fast: 150ms;
            --duration-normal: 250ms;
        }

        * {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--color-text);
            background: var(--color-bg);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-20);
        }

        /* Header */
        header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-20);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: var(--color-text);
        }

        .logo-icon {
            display: inline-block;
            width: 32px;
            height: 32px;
            margin-right: var(--space-12);
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            border-radius: var(--radius-md);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .info-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: var(--space-4) var(--space-12);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn var(--duration-normal);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Setup Form */
        .setup-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            padding: var(--space-32);
            max-width: 600px;
            margin: var(--space-32) auto;
            box-shadow: var(--shadow-sm);
        }

        .form-group {
            margin-bottom: var(--space-24);
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--space-8);
            color: var(--color-text);
        }

        .form-hint {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: var(--space-4);
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: inherit;
            color: var(--color-text);
            background: var(--color-surface);
            transition: all var(--duration-fast);
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .btn {
            padding: var(--space-12) var(--space-24);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--duration-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--space-8);
            white-space: nowrap;
        }

        .btn:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            width: 100%;
            justify-content: center;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:active {
            background: var(--color-primary-active);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        /* Test View */
        .test-view {
            max-width: 750px;
            margin: 0 auto;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--color-border);
            border-radius: var(--radius-full);
            margin-bottom: var(--space-32);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-success));
            transition: width var(--duration-normal);
            border-radius: var(--radius-full);
        }

        .question-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-32);
            margin-bottom: var(--space-24);
            box-shadow: var(--shadow-sm);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-20);
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: var(--space-24);
            color: var(--color-text);
        }

        .likert-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-12);
            margin-bottom: var(--space-24);
        }

        .likert-btn {
            padding: var(--space-12);
            border: 2px solid var(--color-border);
            background: var(--color-surface);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            line-height: 1.3;
            color: var(--color-text-secondary);
            transition: all var(--duration-fast);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
        }

        .likert-btn:hover {
            border-color: var(--color-primary);
            background: #eff6ff;
        }

        .likert-btn:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .likert-btn.selected {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .likert-labels {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-12);
            font-size: 11px;
            color: var(--color-text-secondary);
            text-align: center;
            margin-top: var(--space-8);
        }

        .button-group {
            display: flex;
            gap: var(--space-12);
            margin-top: var(--space-32);
        }

        .button-group .btn {
            flex: 1;
        }

        /* Results View */
        .results-view {
            max-width: 750px;
            margin: 0 auto;
        }

        .results-header {
            text-align: center;
            margin-bottom: var(--space-32);
        }

        .results-header h2 {
            font-size: 28px;
            margin: 0 0 var(--space-8) 0;
            color: var(--color-text);
        }

        .results-description {
            color: var(--color-text-secondary);
            margin-bottom: var(--space-24);
        }

        .result-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-16);
            box-shadow: var(--shadow-sm);
        }

        .result-dimension {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-12);
        }

        .result-dimension-name {
            font-weight: 600;
            color: var(--color-text);
        }

        .result-score {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .result-bar {
            width: 100%;
            height: 8px;
            background: var(--color-border);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--space-8);
        }

        .result-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2563eb, #7c3aed);
            transition: width var(--duration-normal);
        }

        .summary-text {
            background: #f0f9ff;
            border-left: 4px solid var(--color-primary);
            padding: var(--space-16);
            border-radius: var(--radius-md);
            color: var(--color-text);
            line-height: 1.6;
            margin-bottom: var(--space-24);
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-32);
            gap: var(--space-16);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        /* Error State */
        .error-card {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            color: #991b1b;
            margin-bottom: var(--space-16);
        }

        .error-title {
            font-weight: 600;
            margin-bottom: var(--space-8);
        }

        .error-message {
            font-size: 14px;
            margin-bottom: var(--space-12);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .container {
                padding: var(--space-16);
            }

            .header-content {
                padding: var(--space-16);
            }

            h1 {
                font-size: 18px;
            }

            .setup-card {
                padding: var(--space-20);
                margin: var(--space-16) auto;
            }

            .likert-options {
                grid-template-columns: repeat(5, 1fr);
                gap: var(--space-8);
            }

            .likert-btn {
                min-height: 60px;
                font-size: 11px;
                padding: var(--space-8);
            }

            .likert-labels {
                font-size: 10px;
                gap: var(--space-8);
            }

            .question-card {
                padding: var(--space-16);
            }

            .results-header h2 {
                font-size: 22px;
            }
        }

        /* Accessibility */
        :focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1><span class="logo-icon">AI</span> Психометрический Тест</h1>
            <div class="info-badge">v1.0</div>
        </div>
    </header>

    <div class="container">
        <!-- Setup View -->
        <div id="setupView" class="view active">
            <div class="setup-card">
                <h2 style="margin: 0 0 var(--space-24) 0; font-size: 22px;">Создайте свой тест</h2>
                <p style="color: var(--color-text-secondary); margin: 0 0 var(--space-24) 0;">
                    Введите тему и параметры, чтобы сгенерировать персонализированный психометрический тест с помощью AI.
                </p>

                <form id="setupForm" onsubmit="handleSetupSubmit(event)">
                    <div class="form-group">
                        <label for="testTheme">Тема теста *</label>
                        <input 
                            type="text" 
                            id="testTheme" 
                            placeholder="Например: Экстроверсия, Отношение к технологии, Творческость..."
                            required
                        >
                        <div class="form-hint">Основной конструкт или измерение, которое вы хотите оценить</div>
                    </div>

                    <div class="form-group">
                        <label for="targetAudience">Целевая аудитория</label>
                        <input 
                            type="text" 
                            id="targetAudience" 
                            placeholder="Например: Взрослые 25+, IT специалисты, Студенты..."
                            value="Взрослые, общая аудитория"
                        >
                        <div class="form-hint">Помогает адаптировать язык и уровень сложности</div>
                    </div>

                    <div class="form-group">
                        <label for="questionsCount">Количество вопросов</label>
                        <input 
                            type="text" 
                            id="questionsCount" 
                            placeholder="10"
                            value="10"
                        >
                        <div class="form-hint">Рекомендуется 8-15 для балансировки между полнотой и усталостью</div>
                    </div>

                    <div class="form-group">
                        <label for="additionalContext">Дополнительный контекст (опционально)</label>
                        <textarea 
                            id="additionalContext"
                            placeholder="Например: сосредоточьтесь на личных убеждениях, а не на поведении. Избегайте вопросов о политике..."
                        ></textarea>
                        <div class="form-hint">Специальные инструкции для улучшения качества вопросов</div>
                    </div>

                    <div class="form-group">
                        <label for="apiKey">OpenRouter API ключ *</label>
                        <input 
                            type="text" 
                            id="apiKey" 
                            placeholder="sk-or-v1-..."
                            required
                        >
                        <div class="form-hint">
                            Получите на <a href="https://openrouter.ai" target="_blank" rel="noopener" style="color: var(--color-primary);">openrouter.ai</a>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span>Создать тест</span>
                    </button>
                </form>

                <div style="margin-top: var(--space-24); padding-top: var(--space-24); border-top: 1px solid var(--color-border);">
                    <h3 style="margin: 0 0 var(--space-12) 0; font-size: 14px; color: var(--color-text-secondary);">ℹ️ О приложении</h3>
                    <ul style="margin: 0; padding-left: var(--space-20); color: var(--color-text-secondary); font-size: 12px; line-height: 1.6;">
                        <li>Генерирует вопросы с помощью GPT-4/Claude для максимального качества</li>
                        <li>Двухуровневая валидация обеспечивает соответствие психометрическим стандартам</li>
                        <li>5-точечная шкала Лайкерта (рекомендуемый стандарт)</li>
                        <li>Данные хранятся локально в браузере</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Test View -->
        <div id="testView" class="view">
            <div class="test-view">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="question-card">
                    <div class="question-header">
                        <span id="questionCounter">Вопрос 1 из 10</span>
                        <span id="confidenceIndicator" style="color: var(--color-warning);"></span>
                    </div>

                    <div class="question-text" id="questionText">
                        Загрузка вопроса...
                    </div>

                    <div id="validationWarning" style="display: none; background: #fffbeb; border: 1px solid #fbbf24; padding: var(--space-12); border-radius: var(--radius-md); margin-bottom: var(--space-16); font-size: 12px; color: #78350f;">
                        ⚠️ Этот вопрос повторно прошел валидацию из-за потенциальных смещений.
                    </div>

                    <div class="likert-options" id="likertOptions"></div>
                    <div class="likert-labels">
                        <span>Совершенно<br>согласен</span>
                        <span>Согласен</span>
                        <span>Не знаю</span>
                        <span>Не согласен</span>
                        <span>Совершенно<br>не согласен</span>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display: none;">
                            ← Назад
                        </button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>
                            Далее →
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading View -->
        <div id="loadingView" class="view">
            <div class="loading">
                <div class="spinner"></div>
                <div class="loading-text" id="loadingMessage">Генерируем вопросы...</div>
            </div>
        </div>

        <!-- Results View -->
        <div id="resultsView" class="view">
            <div class="results-view">
                <div class="results-header">
                    <h2>Результаты теста</h2>
                    <p class="results-description" id="resultsSubtitle"></p>
                </div>

                <div id="summarySection"></div>

                <div id="dimensionsSection"></div>

                <div style="text-align: center; margin-top: var(--space-32);">
                    <button class="btn btn-primary" onclick="resetTest()" style="width: auto; max-width: 300px;">
                        Создать новый тест
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== STATE MANAGEMENT =====
        const appState = {
            view: 'setup',
            config: null,
            questions: [],
            responses: [],
            currentQuestionIndex: 0,
            apiKey: null,
            stats: {
                validationRetries: 0,
                totalGenerationTime: 0
            }
        };

        // ===== CONFIGURATION =====
        const CONFIG = {
            MODELS: [
                { name: 'xiaomi/mimo-v2-flash:free', priority: 1 },
                { name: 'tngtech/deepseek-r1t-chimera:free', priority: 2 },
                { name: 'tngtech/tng-r1t-chimera:free', priority: 3 }
            ],
            RETRY_ATTEMPTS: 3,
            MAX_QUESTIONS: 20,
            MIN_QUESTIONS: 5,
            VALIDATION_TIMEOUT: 10000,
            GENERATION_TIMEOUT: 30000
        };

        // ===== QUESTION SCHEMA =====
        const QUESTION_SCHEMA = {
            "type": "json_schema",
            "json_schema": {
                "name": "test_question",
                "strict": true,
                "schema": {
                    "type": "object",
                    "properties": {
                        "question": {
                            "type": "string",
                            "description": "Вопрос для Likert-шкалы (5-7 слов, без предположений, нейтральный язык)"
                        },
                        "dimension": {
                            "type": "string",
                            "description": "Психологический конструкт или измерение, которое оценивает вопрос"
                        },
                        "reverse_coded": {
                            "type": "boolean",
                            "description": "Истина, если ответы следует обратить при подсчете"
                        },
                        "difficulty": {
                            "type": "number",
                            "minimum": 1,
                            "maximum": 5,
                            "description": "Уровень когнитивной сложности (1=простой, 5=сложный)"
                        }
                    },
                    "required": ["question", "dimension", "reverse_coded", "difficulty"],
                    "additionalProperties": false
                }
            }
        };

        // ===== PROMPT ENGINEERING =====
        const SYSTEM_PROMPTS = {
            questionGeneration: `Ты опытный психолог и разработчик психометрических тестов с 15-летним опытом.
Твоя задача — генерировать высокопрофессиональные вопросы для психологического теста на основе Likert-шкалы (5 точек).

КРИТИЧЕСКИЕ ТРЕБОВАНИЯ:

1. ОТСУТСТВИЕ СМЕЩЕНИЙ (Bias Prevention):
   - Избегай предположений и наводящих вопросов
   - Используй нейтральный, объективный язык
   - Не используй абсолютные слова ("никогда", "всегда", "все", "никто")
   - Не судите: избегайте "правильно", "неправильно", "хорошо", "плохо" как оценок
   - Не используй эмоционально заряженный язык
   - Не смешивайте концепции в одном вопросе

2. ПСИХОМЕТРИЧЕСКАЯ ТОЧНОСТЬ:
   - Каждый вопрос измеряет ОДНО и только одно психологическое измерение
   - Вопрос должен быть четко сформулирован и понятен для целевой аудитории
   - Избегайте технического жаргона, если он не по теме
   - Вопрос должен быть актуален для всех типов людей

3. ФОРМУЛИРОВКА:
   - Используй простые, четкие слова (избегайте архаизмов)
   - Длина: 10-20 слов оптимально
   - Завершенные предложения, без фрагментов
   - Настоящее время предпочтительно

4. РАЗНООБРАЗИЕ:
   - Варьируй позитивные и обратно кодированные вопросы (некоторые требуют инвертирования ответов)
   - Используй разные когнитивные уровни (простые и сложные)
   - Разные конструкты одного измерения если возможно

ВЫХОДНОЙ ФОРМАТ:
- Возвращай JSON согласно схеме
- Убедись в strict: true соответствии
- Проверь все required поля заполнены`,

            questionValidation: `Ты эксперт в психометрии и контроле качества данных.

Задача: проверить следующий вопрос для психологического теста на Likert-шкале на соответствие психометрическим стандартам.

КРИТЕРИИ ВАЛИДАЦИИ:

1. СООТВЕТСТВИЕ ШКАЛЕ:
   - Вопрос уместен для 5-точечной Likert шкалы?
   - Есть ли ясные крайние позиции?

2. ОТСУТСТВИЕ СМЕЩЕНИЙ:
   - Содержит ли наводящий язык? (социально желаемые ответы)
   - Есть ли предположения о демографике, статусе, компетенции?
   - Присутствует ли эмоциональная зарядка?
   - Есть ли двойные отрицания или путаница?

3. ЯСНОСТЬ И ПОНЯТНОСТЬ:
   - Неоднозначен ли?
   - Слишком ли сложен?
   - Используется ли жаргон неправильно?

4. УНИКАЛЬНОСТЬ:
   - Не повторяет ли смысл других вопросов в наборе?

ВЫХОД:
Вернуть JSON:
{
  "passed": boolean,
  "issues": ["issue1", "issue2"] or [],
  "suggestion": "улучшение вопроса если есть проблемы" or null
}`
        };

        // ===== API FUNCTIONS =====
        async function generateQuestions(config) {
            appState.stats.totalGenerationTime = 0;
            const allQuestions = [];
            const startTime = performance.now();

            const prompt = buildGenerationPrompt(config);
            
            try {
                const response = await callOpenRouterAPI(
                    prompt,
                    QUESTION_SCHEMA,
                    CONFIG.MODELS[0].name
                );

                const parsedResponse = JSON.parse(response);
                
                if (Array.isArray(parsedResponse)) {
                    allQuestions.push(...parsedResponse);
                } else {
                    allQuestions.push(parsedResponse);
                }
            } catch (error) {
                console.error('Generation error:', error);
                throw new Error(`Ошибка при генерации вопросов: ${error.message}`);
            }

            // Validate all questions
            updateLoadingMessage('Валидируем вопросы...');
            const validatedQuestions = await validateAllQuestions(allQuestions);

            appState.stats.totalGenerationTime = performance.now() - startTime;
            return validatedQuestions;
        }

        async function validateAllQuestions(questions) {
            const validated = [];
            let retries = 0;

            for (const question of questions) {
                if (validated.length >= parseInt(appState.config.questionsCount)) break;

                try {
                    const isValid = await validateQuestion(question);
                    if (isValid) {
                        validated.push(question);
                    } else {
                        retries++;
                        if (retries < CONFIG.RETRY_ATTEMPTS) {
                            // Try to improve and re-validate
                            const improved = await improveQuestion(question);
                            const isImprovedValid = await validateQuestion(improved);
                            if (isImprovedValid) {
                                validated.push(improved);
                                appState.stats.validationRetries++;
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Question validation error:', error);
                }
            }

            // Fallback: if we don't have enough questions, accept the best ones
            if (validated.length < parseInt(appState.config.questionsCount)) {
                validated.push(...questions.slice(validated.length, parseInt(appState.config.questionsCount)));
            }

            return validated;
        }

        async function validateQuestion(question) {
            const validationPrompt = `
Вопрос для валидации:
"${question.question}"

Измерение: ${question.dimension}
Обратно кодирован: ${question.reverse_coded}

Проверь соответствие психометрическим стандартам.
            `;

            try {
                const response = await callOpenRouterAPI(
                    validationPrompt,
                    {
                        "type": "json_schema",
                        "json_schema": {
                            "name": "validation_result",
                            "strict": true,
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "passed": { "type": "boolean" },
                                    "issues": { 
                                        "type": "array",
                                        "items": { "type": "string" }
                                    },
                                    "suggestion": { "type": ["string", "null"] }
                                },
                                "required": ["passed", "issues", "suggestion"],
                                "additionalProperties": false
                            }
                        }
                    },
                    CONFIG.MODELS[1].name
                );

                const result = JSON.parse(response);
                return result.passed && result.issues.length === 0;
            } catch (error) {
                console.warn('Validation error:', error);
                return false;
            }
        }

        async function improveQuestion(question) {
            const improvementPrompt = `
Улучши этот вопрос для психологического теста:
"${question.question}"

Требования:
- Сохрани основной смысл
- Сделай его более нейтральным и точным
- Убери потенциальные смещения

Верни улучшенный вопрос в JSON формате.
            `;

            try {
                const response = await callOpenRouterAPI(
                    improvementPrompt,
                    {
                        "type": "json_schema",
                        "json_schema": {
                            "name": "improved_question",
                            "strict": true,
                            "schema": {
                                "type": "object",
                                "properties": {
                                    "question": { "type": "string" },
                                    "dimension": { "type": "string" },
                                    "reverse_coded": { "type": "boolean" },
                                    "difficulty": { "type": "number", "minimum": 1, "maximum": 5 }
                                },
                                "required": ["question", "dimension", "reverse_coded", "difficulty"],
                                "additionalProperties": false
                            }
                        }
                    },
                    CONFIG.MODELS[1].name
                );

                return JSON.parse(response);
            } catch (error) {
                return question;
            }
        }

        async function callOpenRouterAPI(userPrompt, responseFormat, model) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), CONFIG.GENERATION_TIMEOUT);

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'AI Psychometric Test Generator'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: 'system',
                                content: SYSTEM_PROMPTS.questionGeneration
                            },
                            {
                                role: 'user',
                                content: userPrompt
                            }
                        ],
                        response_format: responseFormat,
                        temperature: 0.7,
                        max_tokens: 4000,
                        top_p: 0.95
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeout);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`API Error: ${error.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Handle both raw JSON and embedded JSON
                if (typeof content === 'string') {
                    try {
                        return content;
                    } catch {
                        // Try to extract JSON from markdown code blocks
                        const jsonMatch = content.match(/```json\n?([\s\S]*?)\n?```/);
                        if (jsonMatch) {
                            return jsonMatch[1];
                        }
                        return content;
                    }
                }
                return JSON.stringify(content);
            } catch (error) {
                clearTimeout(timeout);
                if (error.name === 'AbortError') {
                    throw new Error('Timeout при запросе к API');
                }
                throw error;
            }
        }

        // ===== HELPER FUNCTIONS =====
        function buildGenerationPrompt(config) {
            return `Сгенерируй ${config.questionsCount} психометрических вопросов для теста на Likert-шкале.

ПАРАМЕТРЫ:
- Основная тема: ${config.theme}
- Целевая аудитория: ${config.targetAudience}
- Количество вопросов: ${config.questionsCount}
${config.additionalContext ? `- Дополнительный контекст: ${config.additionalContext}` : ''}

ИНСТРУКЦИИ:
1. Каждый вопрос должен быть оценен по шкале от 1 (совершенно не согласен) до 5 (совершенно согласен)
2. Избегай смещений, предположений и эмоционально заряженного языка
3. Вопросы должны быть релевантны для типичного представителя целевой аудитории
4. Включи как прямые, так и обратно кодированные вопросы (reverse_coded = true)
5. Варьируй сложность (difficulty: 1-5)

Верни массив JSON объектов согласно схеме.`;
        }

        function updateLoadingMessage(message) {
            const loadingEl = document.getElementById('loadingMessage');
            if (loadingEl) loadingEl.textContent = message;
        }

        function setView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            const nextView = document.getElementById(viewName + 'View');
            if (nextView) nextView.classList.add('active');
            appState.view = viewName;
        }

        function showError(message) {
            const errorHtml = `
                <div class="error-card">
                    <div class="error-title">❌ Ошибка</div>
                    <div class="error-message">${message}</div>
                    <button class="btn btn-secondary" onclick="resetTest()" style="width: auto;">
                        Вернуться в начало
                    </button>
                </div>
            `;
            
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = errorHtml;
            container.insertBefore(errorDiv, container.firstChild);
        }

        // ===== FORM HANDLING =====
        async function handleSetupSubmit(event) {
            event.preventDefault();

            const theme = document.getElementById('testTheme').value.trim();
            const targetAudience = document.getElementById('targetAudience').value.trim();
            const questionsCount = parseInt(document.getElementById('questionsCount').value);
            const additionalContext = document.getElementById('additionalContext').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            // Validation
            if (!theme) {
                alert('Пожалуйста, введите тему теста');
                return;
            }

            if (questionsCount < CONFIG.MIN_QUESTIONS || questionsCount > CONFIG.MAX_QUESTIONS) {
                alert(`Количество вопросов должно быть от ${CONFIG.MIN_QUESTIONS} до ${CONFIG.MAX_QUESTIONS}`);
                return;
            }

            if (!apiKey) {
                alert('Пожалуйста, введите API ключ');
                return;
            }

            appState.apiKey = apiKey;
            appState.config = {
                theme,
                targetAudience,
                questionsCount,
                additionalContext
            };

            // Generate questions
            setView('loading');
            updateLoadingMessage('Генерируем вопросы для теста...');

            try {
                const questions = await generateQuestions(appState.config);
                appState.questions = questions;
                appState.responses = new Array(questions.length).fill(null);
                appState.currentQuestionIndex = 0;

                setView('test');
                displayQuestion();
            } catch (error) {
                console.error('Error:', error);
                setView('setup');
                showError(error.message || 'Неизвестная ошибка при генерации');
            }
        }

        function displayQuestion() {
            if (appState.currentQuestionIndex >= appState.questions.length) {
                displayResults();
                return;
            }

            const question = appState.questions[appState.currentQuestionIndex];
            const response = appState.responses[appState.currentQuestionIndex];
            const progress = ((appState.currentQuestionIndex) / appState.questions.length) * 100;

            // Update progress
            document.getElementById('progressFill').style.width = progress + '%';

            // Update counter
            document.getElementById('questionCounter').textContent = 
                `Вопрос ${appState.currentQuestionIndex + 1} из ${appState.questions.length}`;

            // Update confidence indicator
            const confidenceEl = document.getElementById('confidenceIndicator');
            if (appState.stats.validationRetries > 0) {
                confidenceEl.textContent = '⚙️ Переvалидирован';
                document.getElementById('validationWarning').style.display = 'block';
            } else {
                confidenceEl.textContent = '';
                document.getElementById('validationWarning').style.display = 'none';
            }

            // Update question text
            document.getElementById('questionText').textContent = question.question;

            // Create Likert options
            const optionsContainer = document.getElementById('likertOptions');
            optionsContainer.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'likert-btn' + (response === i ? ' selected' : '');
                btn.textContent = i;
                btn.onclick = () => selectResponse(i);
                optionsContainer.appendChild(btn);
            }

            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            prevBtn.style.display = appState.currentQuestionIndex > 0 ? 'flex' : 'none';
            nextBtn.disabled = response === null;
            nextBtn.textContent = appState.currentQuestionIndex === appState.questions.length - 1 
                ? 'Завершить ✓'
                : 'Далее →';
        }

        function selectResponse(value) {
            appState.responses[appState.currentQuestionIndex] = value;
            
            // Update button state
            const buttons = document.querySelectorAll('.likert-btn');
            buttons.forEach((btn, idx) => {
                if (idx + 1 === value) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });

            // Enable next button
            document.getElementById('nextBtn').disabled = false;
        }

        function nextQuestion() {
            if (appState.currentQuestionIndex < appState.questions.length - 1) {
                appState.currentQuestionIndex++;
                displayQuestion();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                displayResults();
            }
        }

        function previousQuestion() {
            if (appState.currentQuestionIndex > 0) {
                appState.currentQuestionIndex--;
                displayQuestion();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function displayResults() {
            const results = calculateResults();
            
            // Update subtitle
            document.getElementById('resultsSubtitle').textContent = 
                `Тест на "${appState.config.theme}" завершен`;

            // Calculate and display summary
            const overallScore = results.overallScore;
            const summaryText = interpretScore(appState.config.theme, overallScore);

            document.getElementById('summarySection').innerHTML = `
                <div class="summary-text">
                    <strong>Ваш результат:</strong> ${overallScore.toFixed(1)}/5.0
                    <br><br>
                    ${summaryText}
                </div>
            `;

            // Display dimensions
            const dimensionsHtml = results.dimensions.map(dim => `
                <div class="result-card">
                    <div class="result-dimension">
                        <span class="result-dimension-name">${dim.name}</span>
                        <span class="result-score">${dim.score.toFixed(2)}</span>
                    </div>
                    <div class="result-bar">
                        <div class="result-bar-fill" style="width: ${(dim.score / 5) * 100}%"></div>
                    </div>
                </div>
            `).join('');

            document.getElementById('dimensionsSection').innerHTML = dimensionsHtml;

            setView('results');
        }

        function calculateResults() {
            const dimensions = {};
            
            // Group questions by dimension
            appState.questions.forEach((q, idx) => {
                if (!dimensions[q.dimension]) {
                    dimensions[q.dimension] = [];
                }
                
                let score = appState.responses[idx];
                if (q.reverse_coded) {
                    score = 6 - score; // Reverse: 1->5, 2->4, etc.
                }
                
                dimensions[q.dimension].push(score);
            });

            // Calculate average for each dimension
            const dimensionResults = Object.entries(dimensions).map(([name, scores]) => ({
                name,
                score: scores.reduce((a, b) => a + b, 0) / scores.length
            }));

            // Calculate overall score
            const overallScore = dimensionResults.reduce((sum, d) => sum + d.score, 0) / dimensionResults.length;

            return {
                dimensions: dimensionResults,
                overallScore
            };
        }

        function interpretScore(theme, score) {
            if (score >= 4.5) {
                return `Вы показываете <strong>очень высокий уровень</strong> по измерению "${theme}".`;
            } else if (score >= 3.5) {
                return `Вы показываете <strong>высокий уровень</strong> по измерению "${theme}".`;
            } else if (score >= 2.5) {
                return `Ваш уровень по измерению "${theme}" <strong>умеренный</strong>.`;
            } else if (score >= 1.5) {
                return `Вы показываете <strong>низкий уровень</strong> по измерению "${theme}".`;
            } else {
                return `Вы показываете <strong>очень низкий уровень</strong> по измерению "${theme}".`;
            }
        }

        function resetTest() {
            appState.view = 'setup';
            appState.questions = [];
            appState.responses = [];
            appState.currentQuestionIndex = 0;
            appState.config = null;
            appState.stats = { validationRetries: 0, totalGenerationTime: 0 };
            
            document.getElementById('setupForm').reset();
            setView('setup');
        }
    </script>
</body>
</html>
