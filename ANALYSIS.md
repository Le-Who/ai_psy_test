# Полный архитектурный анализ проекта `ai_psy_test`

## 1) Быстрый вывод (TL;DR)

Приложение — это **single-page web app без сборщика**, где вся бизнес-логика живёт в глобальном объекте `app`, а инфраструктурные слои вынесены в модули `api`, `Storage`, `Utils` и `app-settings` (схемы + промпты). Продукт покрывает 3 сценария: генерация психометрического теста, генерация викторины и дуэль по ссылке. Архитектура рабочая и прагматичная, но в коде есть критичные дефекты (в т.ч. баг парсинга hash-ссылки дуэли, небезопасные обращения к вложенным полям API-ответов, потенциальный `ReferenceError` по `TINYTOKEN`, XSS-риск через `innerHTML` с текстом ошибок, уязвимость инлайн-`onclick` при `'` в ID). Также заметен «долг» по тестируемости: отсутствуют unit/e2e-тесты и контрактная валидация ответов LLM.

---

## 2) Ментальная карта приложения

## 2.1 Слои

1. **Presentation/UI слой**
   - `index.html`: все view-компоненты (setup/test/results/library/duel), inline-обработчики и вспомогательные UI-функции темизации.
   - `style.css`: glassmorphism UI, карточки, сетки, кнопки, состояния.

2. **Application слой**
   - `app.js`: state machine и оркестрация всего флоу.
   - Основные обязанности:
     - инициализация UI и событий;
     - запуск генерации (архитектура + вопросы);
     - рендер вопросов, навигация;
     - подсчёт результатов;
     - создание share-ссылки / сохранение в библиотеку.

3. **Infrastructure слой**
   - `api.js`: выбор провайдера (`gemini`/`openrouter`), сборка промптов, HTTP-вызовы.
   - `storage.js`: persistance в localStorage + кеши рендеринга.
   - `utils.js`: escapeHtml, togglePasswordVisibility.

4. **Domain/config слой**
   - `app-settings.js`: `CONFIG`, JSON-схемы (`SCHEMAS`), тексты системных промптов (`PROMPTS`).

## 2.2 Потоки данных (главные use-cases)

### A. Генерация теста
1) Пользователь заполняет setup-форму.
2) `app.start()` валидирует ввод, сохраняет API-ключ.
3) `api.call("architect_*", ...)` возвращает blueprint.
4) `api.call("generator_*", ...)` возвращает вопросы (массив или обёртка `{ questions, ...meta }`).
5) Для `psy`: `normalizePsyQuestions()` стабилизирует mapping/weights/polarity.
6) `renderQ()` показывает вопросы.
7) По завершении `calc()` строит HTML результата и кнопки Save/Share.

### B. Дуэль по ссылке
1) При старте `checkHash()` смотрит `window.location.hash`.
2) При валидных данных в hash восстанавливаются `blueprint/questions/host score`.
3) `showDuelIntro()` показывает превью дуэли.
4) `startDuelTest()` запускает прохождение как quiz/psy в duel-режиме.
5) `calc()` дополнительно рисует блок сравнения score.

### C. Библиотека
1) `saveTest()` формирует payload и сохраняет в `Storage.save(...)`.
2) `Storage` поддерживает кеши `_cache`, `_htmlItems`, `_renderedHtmlCache`, `_themesCache`.
3) `openLibrary()` вставляет `Storage.renderLibraryHTML()`.
4) `deleteTest()` — двухкликовое подтверждение и удаление.

---

## 3) Сильные стороны кода

- Разделение на файлы по ответственности есть (UI/app vs API vs Storage vs config).
- Есть минимум защит от XSS через `Utils.escapeHtml()` и активное применение в ряде мест.
- Реализована нормализация психометрических вопросов и fallback-логика для отсутствующих метаданных.
- Библиотека тестов оптимизирована кешами (рендер/темы) и синхронизацией между вкладками (`storage` event).
- UX-фичи: toast, confetti, авто-переходы, тумблер тем.

---

## 4) Проблемные места и рекомендации по исправлению

## P0 — критично (исправить в первую очередь)

### 4.1 Баг формата hash в дуэли (`#d:` vs `#d=`)

**Проблема:**
- `checkHash()` ищет `#d:` и берёт `substring(3)`.
- `createShareLink()` и `saveTest()` формируют ссылку в формате `#d=${compressed}`.
- Итог: дуэльные ссылки не парсятся.

**Решение:**
- Унифицировать префикс, например на `#d=` везде.
- В `checkHash()` временно поддержать оба формата (backward-compatible).

---

### 4.2 Потенциальный `ReferenceError` при `TINYTOKEN`

**Проблема:**
- В `createShareLink()` используется `if(!TINYTOKEN)`.
- Если глобальная переменная не объявлена в рантайме, это `ReferenceError` (а не `false`).

**Решение:**
- Безопасная проверка: `if (typeof TINYTOKEN === 'undefined' || !TINYTOKEN) ...`.
- Альтернатива: хранить токен в `CONFIG`.

---

### 4.3 Отсутствие защит при чтении API-ответа

**Проблема:**
- `api.js` читает `data.choices[0].message.content` и `data.candidates[0].content.parts[0].text` без optional chaining и проверок.
- При ошибках API/лимитах структура отличается → краш.

**Решение:**
- Добавить проверку `res.ok`; при `!ok` читать текст ошибки и кидать понятный `Error`.
- Использовать optional chaining + guarded error.
- В `safeParseJSON` расширить выделение JSON (иногда модель возвращает массив с префиксным текстом).

---

### 4.4 XSS-риск через `errorBox.innerHTML = err.message`

**Проблема:**
- Сообщения об ошибке могут содержать HTML.

**Решение:**
- Использовать `textContent`.
- Если нужен rich-text, то только после строгой санации.

---

### 4.5 Инъекция/поломка через inline `onclick` в library

**Проблема:**
- В `Storage._renderTestItem()` ID теста встраивается в строку `onclick="app.loadSavedTest('${test.id}')"`.
- Если `id` содержит `'`, ломается HTML/JS.

**Решение:**
- Убрать inline JS: data-атрибут + делегирование событий в `app`.
- Либо экранировать отдельно для JS-контекста.

---

## P1 — важные

### 4.6 `showDuelIntro()` не проверяет `duelView` на `null`

**Решение:** guard + fail-safe toast/redirect.

### 4.7 Разнородный стиль подписки на события

Часть обработчиков назначается и в HTML (`onclick`), и через `addEventListener`.

**Решение:**
- Свести всё к `addEventListener` + делегирование.
- Упростит тестирование и CSP.

### 4.8 Слабая контрактная валидация ответов LLM

Сейчас есть JSON Schema в промпте, но нет реального runtime-валидатора.

**Решение:**
- Добавить AJV-подобную валидацию перед использованием `blueprint/questions`.
- При невалидном ответе: авто-retry (1–2 раза) с диагностическим промптом.

### 4.9 Нечёткая математика в `getBaseScore`

`return a - 1 * 2.5;` читается как legacy/ошибка приоритета (формально это `a - 2.5`).

**Решение:**
- Явно записать формулу и диапазон (например, map 1..5 в 0..10 или -2..2).
- Добавить unit-тесты для scoring.

---

## P2 — улучшения качества

### 4.10 Нет тестов

**Рекомендуемый минимальный пакет:**
- Unit:
  - `normalizePsyQuestions`;
  - `safeParseJSON`;
  - scoring в `calc` (вынести в pure-функции).
- Интеграционные:
  - hash-duel roundtrip (`createShareLink` ↔ `checkHash`).
- E2E:
  - happy-path psy/quiz.

### 4.11 Монолитный `calc()` и `start()`

Функции большие и трудно тестируются.

**Решение:**
- Вынести в модули:
  - `score/psyScore.js`
  - `score/quizScore.js`
  - `render/resultsRenderer.js`

### 4.12 Наблюдаемость

Логирование только `console.*`.

**Решение:**
- Ввести `logger`-обёртку с уровнями и флагом debug.

---

## 5) Приоритетный roadmap исправлений

1. **P0.1** Исправить hash-префикс дуэли + обратную совместимость.
2. **P0.2** Безопасные проверки `TINYTOKEN`, `res.ok`, optional chaining в `api.js`.
3. **P0.3** Убрать `innerHTML` для ошибок и inline-обработчики в library.
4. **P1.1** Внедрить runtime-валидацию схем API-ответов.
5. **P1.2** Разбить `calc()` на чистые функции + покрыть unit-тестами.
6. **P2.1** Перевести остальные inline `onclick` на делегирование.

---

## 6) Предложенный «быстрый патч» (минимальный набор)

- `app.js`
  - `checkHash()` распознаёт `#d=` и `#d:`.
  - `createShareLink()`/`saveTest()` используют один и тот же префикс.
  - `errorBox.textContent = err.message`.

- `api.js`
  - `if (!res.ok) throw ...` для обоих провайдеров.
  - безаварийный разбор полей ответа.

- `storage.js`
  - заменить inline `onclick` на data-id и делегирование.

---

## 7) Риски после исправлений

- Изменение формата hash может «сломать» старые ссылки без backward-compat.
- Более строгая валидация schema увеличит количество «ошибок генерации» (но повысит надёжность).
- Рефактор event-handlers потребует аккуратной проверки accessibility.

---

## 8) Что мешает TDD-циклу из пользовательской инструкции

Файл `PROJECT.txt` отсутствует в репозитории, поэтому формальный цикл «реализовать MVP из PROJECT.txt» выполнить нельзя без подмены source of truth. Для этого проекта корректнее сначала определить/добавить `PROJECT.txt` либо зафиксировать текущий scope как baseline.

